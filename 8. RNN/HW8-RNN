{"nbformat":4,"nbformat_minor":0,"metadata":{"colab":{"name":"HW8-RNN","provenance":[],"collapsed_sections":[],"mount_file_id":"1caRpoJNO9LGJC5AnrJdwx7wGYPPGYCG_","authorship_tag":"ABX9TyOlaMGVuvCGKc69ZafjVS3N"},"kernelspec":{"name":"python3","display_name":"Python 3"},"language_info":{"name":"python"},"accelerator":"GPU","widgets":{"application/vnd.jupyter.widget-state+json":{"8ece86adbe9144e8a80302b081fcd68f":{"model_module":"@jupyter-widgets/controls","model_name":"HBoxModel","state":{"_view_name":"HBoxView","_dom_classes":[],"_model_name":"HBoxModel","_view_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_view_count":null,"_view_module_version":"1.5.0","box_style":"","layout":"IPY_MODEL_6e91bf4c7dfc4c4da9a0b10124c9488a","_model_module":"@jupyter-widgets/controls","children":["IPY_MODEL_3c4b72e94d65409c802eccfc7ebc87aa","IPY_MODEL_e84269a29ad24999ac89e9db115a2e73"]}},"6e91bf4c7dfc4c4da9a0b10124c9488a":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","state":{"_view_name":"LayoutView","grid_template_rows":null,"right":null,"justify_content":null,"_view_module":"@jupyter-widgets/base","overflow":null,"_model_module_version":"1.2.0","_view_count":null,"flex_flow":null,"width":null,"min_width":null,"border":null,"align_items":null,"bottom":null,"_model_module":"@jupyter-widgets/base","top":null,"grid_column":null,"overflow_y":null,"overflow_x":null,"grid_auto_flow":null,"grid_area":null,"grid_template_columns":null,"flex":null,"_model_name":"LayoutModel","justify_items":null,"grid_row":null,"max_height":null,"align_content":null,"visibility":null,"align_self":null,"height":null,"min_height":null,"padding":null,"grid_auto_rows":null,"grid_gap":null,"max_width":null,"order":null,"_view_module_version":"1.2.0","grid_template_areas":null,"object_position":null,"object_fit":null,"grid_auto_columns":null,"margin":null,"display":null,"left":null}},"3c4b72e94d65409c802eccfc7ebc87aa":{"model_module":"@jupyter-widgets/controls","model_name":"FloatProgressModel","state":{"_view_name":"ProgressView","style":"IPY_MODEL_8c7721b634d74e21b742582547ac43b5","_dom_classes":[],"description":"100%","_model_name":"FloatProgressModel","bar_style":"success","max":6000,"_view_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","value":6000,"_view_count":null,"_view_module_version":"1.5.0","orientation":"horizontal","min":0,"description_tooltip":null,"_model_module":"@jupyter-widgets/controls","layout":"IPY_MODEL_9f949ebb958d4ee7b6787fc8264d8a22"}},"e84269a29ad24999ac89e9db115a2e73":{"model_module":"@jupyter-widgets/controls","model_name":"HTMLModel","state":{"_view_name":"HTMLView","style":"IPY_MODEL_3db02d7e07024352b4a379e1f7db79ef","_dom_classes":[],"description":"","_model_name":"HTMLModel","placeholder":"​","_view_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","value":" 6000/6000 [11:56&lt;00:00,  8.37it/s]","_view_count":null,"_view_module_version":"1.5.0","description_tooltip":null,"_model_module":"@jupyter-widgets/controls","layout":"IPY_MODEL_7cf88927095649ccaa100d7cae1418a9"}},"8c7721b634d74e21b742582547ac43b5":{"model_module":"@jupyter-widgets/controls","model_name":"ProgressStyleModel","state":{"_view_name":"StyleView","_model_name":"ProgressStyleModel","description_width":"initial","_view_module":"@jupyter-widgets/base","_model_module_version":"1.5.0","_view_count":null,"_view_module_version":"1.2.0","bar_color":null,"_model_module":"@jupyter-widgets/controls"}},"9f949ebb958d4ee7b6787fc8264d8a22":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","state":{"_view_name":"LayoutView","grid_template_rows":null,"right":null,"justify_content":null,"_view_module":"@jupyter-widgets/base","overflow":null,"_model_module_version":"1.2.0","_view_count":null,"flex_flow":null,"width":null,"min_width":null,"border":null,"align_items":null,"bottom":null,"_model_module":"@jupyter-widgets/base","top":null,"grid_column":null,"overflow_y":null,"overflow_x":null,"grid_auto_flow":null,"grid_area":null,"grid_template_columns":null,"flex":null,"_model_name":"LayoutModel","justify_items":null,"grid_row":null,"max_height":null,"align_content":null,"visibility":null,"align_self":null,"height":null,"min_height":null,"padding":null,"grid_auto_rows":null,"grid_gap":null,"max_width":null,"order":null,"_view_module_version":"1.2.0","grid_template_areas":null,"object_position":null,"object_fit":null,"grid_auto_columns":null,"margin":null,"display":null,"left":null}},"3db02d7e07024352b4a379e1f7db79ef":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","state":{"_view_name":"StyleView","_model_name":"DescriptionStyleModel","description_width":"","_view_module":"@jupyter-widgets/base","_model_module_version":"1.5.0","_view_count":null,"_view_module_version":"1.2.0","_model_module":"@jupyter-widgets/controls"}},"7cf88927095649ccaa100d7cae1418a9":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","state":{"_view_name":"LayoutView","grid_template_rows":null,"right":null,"justify_content":null,"_view_module":"@jupyter-widgets/base","overflow":null,"_model_module_version":"1.2.0","_view_count":null,"flex_flow":null,"width":null,"min_width":null,"border":null,"align_items":null,"bottom":null,"_model_module":"@jupyter-widgets/base","top":null,"grid_column":null,"overflow_y":null,"overflow_x":null,"grid_auto_flow":null,"grid_area":null,"grid_template_columns":null,"flex":null,"_model_name":"LayoutModel","justify_items":null,"grid_row":null,"max_height":null,"align_content":null,"visibility":null,"align_self":null,"height":null,"min_height":null,"padding":null,"grid_auto_rows":null,"grid_gap":null,"max_width":null,"order":null,"_view_module_version":"1.2.0","grid_template_areas":null,"object_position":null,"object_fit":null,"grid_auto_columns":null,"margin":null,"display":null,"left":null}},"e32d3968e951410d814681f812e943ec":{"model_module":"@jupyter-widgets/controls","model_name":"HBoxModel","state":{"_view_name":"HBoxView","_dom_classes":[],"_model_name":"HBoxModel","_view_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_view_count":null,"_view_module_version":"1.5.0","box_style":"","layout":"IPY_MODEL_a9936c0d69ad4f3fa70eda4d5f1c456c","_model_module":"@jupyter-widgets/controls","children":["IPY_MODEL_39ed082fdb6540cc98fc4cc2327bb49c","IPY_MODEL_ab4d5f56634e4694acba9a1f2660f8ee"]}},"a9936c0d69ad4f3fa70eda4d5f1c456c":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","state":{"_view_name":"LayoutView","grid_template_rows":null,"right":null,"justify_content":null,"_view_module":"@jupyter-widgets/base","overflow":null,"_model_module_version":"1.2.0","_view_count":null,"flex_flow":null,"width":null,"min_width":null,"border":null,"align_items":null,"bottom":null,"_model_module":"@jupyter-widgets/base","top":null,"grid_column":null,"overflow_y":null,"overflow_x":null,"grid_auto_flow":null,"grid_area":null,"grid_template_columns":null,"flex":null,"_model_name":"LayoutModel","justify_items":null,"grid_row":null,"max_height":null,"align_content":null,"visibility":null,"align_self":null,"height":null,"min_height":null,"padding":null,"grid_auto_rows":null,"grid_gap":null,"max_width":null,"order":null,"_view_module_version":"1.2.0","grid_template_areas":null,"object_position":null,"object_fit":null,"grid_auto_columns":null,"margin":null,"display":null,"left":null}},"39ed082fdb6540cc98fc4cc2327bb49c":{"model_module":"@jupyter-widgets/controls","model_name":"FloatProgressModel","state":{"_view_name":"ProgressView","style":"IPY_MODEL_dc55e0e45c7a46588db83684e2076722","_dom_classes":[],"description":"100%","_model_name":"FloatProgressModel","bar_style":"success","max":1000,"_view_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","value":1000,"_view_count":null,"_view_module_version":"1.5.0","orientation":"horizontal","min":0,"description_tooltip":null,"_model_module":"@jupyter-widgets/controls","layout":"IPY_MODEL_ee8a1a5ea766415c9575d07ad5ca197c"}},"ab4d5f56634e4694acba9a1f2660f8ee":{"model_module":"@jupyter-widgets/controls","model_name":"HTMLModel","state":{"_view_name":"HTMLView","style":"IPY_MODEL_e394984ef9254c4a99491eccb4c01d40","_dom_classes":[],"description":"","_model_name":"HTMLModel","placeholder":"​","_view_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","value":" 1000/1000 [01:46&lt;00:00,  9.39it/s]","_view_count":null,"_view_module_version":"1.5.0","description_tooltip":null,"_model_module":"@jupyter-widgets/controls","layout":"IPY_MODEL_859f4e4e870e4f40a680bbceb1f2587a"}},"dc55e0e45c7a46588db83684e2076722":{"model_module":"@jupyter-widgets/controls","model_name":"ProgressStyleModel","state":{"_view_name":"StyleView","_model_name":"ProgressStyleModel","description_width":"initial","_view_module":"@jupyter-widgets/base","_model_module_version":"1.5.0","_view_count":null,"_view_module_version":"1.2.0","bar_color":null,"_model_module":"@jupyter-widgets/controls"}},"ee8a1a5ea766415c9575d07ad5ca197c":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","state":{"_view_name":"LayoutView","grid_template_rows":null,"right":null,"justify_content":null,"_view_module":"@jupyter-widgets/base","overflow":null,"_model_module_version":"1.2.0","_view_count":null,"flex_flow":null,"width":null,"min_width":null,"border":null,"align_items":null,"bottom":null,"_model_module":"@jupyter-widgets/base","top":null,"grid_column":null,"overflow_y":null,"overflow_x":null,"grid_auto_flow":null,"grid_area":null,"grid_template_columns":null,"flex":null,"_model_name":"LayoutModel","justify_items":null,"grid_row":null,"max_height":null,"align_content":null,"visibility":null,"align_self":null,"height":null,"min_height":null,"padding":null,"grid_auto_rows":null,"grid_gap":null,"max_width":null,"order":null,"_view_module_version":"1.2.0","grid_template_areas":null,"object_position":null,"object_fit":null,"grid_auto_columns":null,"margin":null,"display":null,"left":null}},"e394984ef9254c4a99491eccb4c01d40":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","state":{"_view_name":"StyleView","_model_name":"DescriptionStyleModel","description_width":"","_view_module":"@jupyter-widgets/base","_model_module_version":"1.5.0","_view_count":null,"_view_module_version":"1.2.0","_model_module":"@jupyter-widgets/controls"}},"859f4e4e870e4f40a680bbceb1f2587a":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","state":{"_view_name":"LayoutView","grid_template_rows":null,"right":null,"justify_content":null,"_view_module":"@jupyter-widgets/base","overflow":null,"_model_module_version":"1.2.0","_view_count":null,"flex_flow":null,"width":null,"min_width":null,"border":null,"align_items":null,"bottom":null,"_model_module":"@jupyter-widgets/base","top":null,"grid_column":null,"overflow_y":null,"overflow_x":null,"grid_auto_flow":null,"grid_area":null,"grid_template_columns":null,"flex":null,"_model_name":"LayoutModel","justify_items":null,"grid_row":null,"max_height":null,"align_content":null,"visibility":null,"align_self":null,"height":null,"min_height":null,"padding":null,"grid_auto_rows":null,"grid_gap":null,"max_width":null,"order":null,"_view_module_version":"1.2.0","grid_template_areas":null,"object_position":null,"object_fit":null,"grid_auto_columns":null,"margin":null,"display":null,"left":null}}}}},"cells":[{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"FgWLLdBmFUeW","executionInfo":{"status":"ok","timestamp":1628517370387,"user_tz":-420,"elapsed":556,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"05cf4fac-9d46-4f4c-de82-64024c5fed4b"},"source":["!nvidia-smi"],"execution_count":1,"outputs":[{"output_type":"stream","text":["Mon Aug  9 13:56:09 2021       \n","+-----------------------------------------------------------------------------+\n","| NVIDIA-SMI 470.42.01    Driver Version: 460.32.03    CUDA Version: 11.2     |\n","|-------------------------------+----------------------+----------------------+\n","| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\n","| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\n","|                               |                      |               MIG M. |\n","|===============================+======================+======================|\n","|   0  Tesla K80           Off  | 00000000:00:04.0 Off |                    0 |\n","| N/A   54C    P8    33W / 149W |      0MiB / 11441MiB |      0%      Default |\n","|                               |                      |                  N/A |\n","+-------------------------------+----------------------+----------------------+\n","                                                                               \n","+-----------------------------------------------------------------------------+\n","| Processes:                                                                  |\n","|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |\n","|        ID   ID                                                   Usage      |\n","|=============================================================================|\n","|  No running processes found                                                 |\n","+-----------------------------------------------------------------------------+\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"qTPqz8IzFgCO","executionInfo":{"status":"ok","timestamp":1628528879541,"user_tz":-420,"elapsed":472,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["# import libs\n","import numpy as np\n","from numpy import array\n","import matplotlib.pyplot as plt\n","import pandas as pd\n","import string\n","import os\n","from PIL import Image\n","import glob\n","from pickle import dump, load\n","from time import time\n","from keras.preprocessing import sequence, image\n","from keras.models import Sequential, Model\n","from keras.layers import LSTM, Embedding, TimeDistributed, Dense, RepeatVector, Activation, Flatten, Reshape, Concatenate, Dropout, BatchNormalization\n","from keras.optimizers import Adam, RMSprop\n","from keras.layers.wrappers import Bidirectional\n","from keras.layers.merge import add\n","from keras.applications.inception_v3 import InceptionV3, preprocess_input\n","from keras import Input, layers\n","from keras import optimizers\n","from keras.preprocessing.text import Tokenizer\n","from keras.preprocessing.sequence import pad_sequences\n","from keras.utils.np_utils import to_categorical\n","from tqdm import tqdm_notebook"],"execution_count":171,"outputs":[]},{"cell_type":"code","metadata":{"id":"t2X1TLCDRXbi","executionInfo":{"status":"ok","timestamp":1628528881410,"user_tz":-420,"elapsed":2,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["%matplotlib inline"],"execution_count":172,"outputs":[]},{"cell_type":"markdown","metadata":{"id":"CaFHd9gnFOlv"},"source":["##Image Captioning\n"]},{"cell_type":"code","metadata":{"id":"v-TO0vrmEyT6","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1628528882625,"user_tz":-420,"elapsed":3,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"8bd718df-dcfe-42dd-9e19-fd962281e79a"},"source":["# Đọc file các caption\n","def load_doc(filename):\n","\t# open the file as read only\n","\tfile = open(filename, 'r')\n","\t# read all text\n","\ttext = file.read()\n","\t# close the file\n","\tfile.close()\n","\treturn text\n","\n","filename = '/content/drive/MyDrive/The Anh Tran/8. RNN/Flickr8k_text/Flickr8k.token.txt'\n","\n","doc = load_doc(filename)\n","\n","# Định dạng được lưu trong doc\n","print(doc[:300])"],"execution_count":173,"outputs":[{"output_type":"stream","text":["1000268201_693b08cb0e.jpg#0\tA child in a pink dress is climbing up a set of stairs in an entry way .\n","1000268201_693b08cb0e.jpg#1\tA girl going into a wooden building .\n","1000268201_693b08cb0e.jpg#2\tA little girl climbing into a wooden playhouse .\n","1000268201_693b08cb0e.jpg#3\tA little girl climbing the s\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"rfrJZuqPHSwz","executionInfo":{"status":"ok","timestamp":1628528886063,"user_tz":-420,"elapsed":495,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"72b806c0-ce95-434b-9a8c-cc670f717710"},"source":["# Lưu caption dưới dạng key value: id_image : ['caption 1', 'caption 2', 'caption 3',' caption 4', 'caption 5']\n","def load_descriptions(doc):\n","\tmapping = dict()\n","\t# process lines\n","\tfor line in doc.split('\\n'):\n","\t\t# split line by white space\n","\t\ttokens = line.split()\n","\t\tif len(line) < 2:\n","\t\t\tcontinue\n","\t\t# take the first token as the image id, the rest as the description\n","\t\timage_id, image_desc = tokens[0], tokens[1:]\n","\t\t# extract filename from image id\n","\t\timage_id = image_id.split('.')[0]\n","\t\t# convert description tokens back to string\n","\t\timage_desc = ' '.join(image_desc)\n","\t\t# create the list if needed\n","\t\tif image_id not in mapping:\n","\t\t\tmapping[image_id] = list()\n","\t\t# store description\n","\t\tmapping[image_id].append(image_desc)\n","\treturn mapping\n","\n","descriptions = load_descriptions(doc)\n","print('Loaded: %d ' % len(descriptions))"],"execution_count":174,"outputs":[{"output_type":"stream","text":["Loaded: 8092 \n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"Q4nWlPNtI5oC","executionInfo":{"status":"ok","timestamp":1628528887504,"user_tz":-420,"elapsed":3,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"9a9d14b2-74b1-47d4-da21-fe0969895d77"},"source":["descriptions['1000268201_693b08cb0e']"],"execution_count":175,"outputs":[{"output_type":"execute_result","data":{"text/plain":["['A child in a pink dress is climbing up a set of stairs in an entry way .',\n"," 'A girl going into a wooden building .',\n"," 'A little girl climbing into a wooden playhouse .',\n"," 'A little girl climbing the stairs to her playhouse .',\n"," 'A little girl in a pink dress going into a wooden cabin .']"]},"metadata":{"tags":[]},"execution_count":175}]},{"cell_type":"code","metadata":{"id":"wL6wN93nKdsW","executionInfo":{"status":"ok","timestamp":1628528889349,"user_tz":-420,"elapsed":663,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["# Preprocessing text\n","def clean_descriptions(descriptions):\n","\t# prepare translation table for removing punctuation\n","\ttable = str.maketrans('', '', string.punctuation)\n","\tfor key, desc_list in descriptions.items():\n","\t\tfor i in range(len(desc_list)):\n","\t\t\tdesc = desc_list[i]\n","\t\t\t# tokenize\n","\t\t\tdesc = desc.split()\n","\t\t\t# convert to lower case\n","\t\t\tdesc = [word.lower() for word in desc]\n","\t\t\t# remove punctuation from each token\n","\t\t\tdesc = [w.translate(table) for w in desc]\n","\t\t\t# remove hanging 's' and 'a'\n","\t\t\tdesc = [word for word in desc if len(word)>1]\n","\t\t\t# remove tokens with numbers in them\n","\t\t\tdesc = [word for word in desc if word.isalpha()]\n","\t\t\t# store as string\n","\t\t\tdesc_list[i] =  ' '.join(desc)\n","\n","# clean descriptions\n","clean_descriptions(descriptions)"],"execution_count":176,"outputs":[]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"CUbANTv_Kj_f","executionInfo":{"status":"ok","timestamp":1628528891096,"user_tz":-420,"elapsed":3,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"62479d7a-99d9-4195-ea25-30e90019556d"},"source":["descriptions['1000268201_693b08cb0e']"],"execution_count":177,"outputs":[{"output_type":"execute_result","data":{"text/plain":["['child in pink dress is climbing up set of stairs in an entry way',\n"," 'girl going into wooden building',\n"," 'little girl climbing into wooden playhouse',\n"," 'little girl climbing the stairs to her playhouse',\n"," 'little girl in pink dress going into wooden cabin']"]},"metadata":{"tags":[]},"execution_count":177}]},{"cell_type":"code","metadata":{"id":"pTvF6dXFNCAX","executionInfo":{"status":"ok","timestamp":1628528892873,"user_tz":-420,"elapsed":3,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["# Lưu description xuống file\n","def save_descriptions(descriptions, filename):\n","\tlines = list()\n","\tfor key, desc_list in descriptions.items():\n","\t\tfor desc in desc_list:\n","\t\t\tlines.append(key + ' ' + desc)\n","\tdata = '\\n'.join(lines)\n","\tfile = open(filename, 'w')\n","\tfile.write(data)\n","\tfile.close()\n","\n","\n","save_descriptions(descriptions, '/content/drive/MyDrive/The Anh Tran/8. RNN/descriptions.txt')"],"execution_count":178,"outputs":[]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"KhMH2opkNRB7","executionInfo":{"status":"ok","timestamp":1628528896137,"user_tz":-420,"elapsed":495,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"53da9106-e6aa-4de8-d252-f1286da7d3ed"},"source":["# Lấy id ảnh tương ứng với dữ liệu train, test, dev\n","def load_set(filename):\n","\tdoc = load_doc(filename)\n","\tdataset = list()\n","\t# process line by line\n","\tfor line in doc.split('\\n'):\n","\t\t# skip empty lines\n","\t\tif len(line) < 1:\n","\t\t\tcontinue\n","\t\t# get the image identifier\n","\t\tidentifier = line.split('.')[0]\n","\t\tdataset.append(identifier)\n","\treturn set(dataset)\n","\n","# load training dataset\n","filename = '/content/drive/MyDrive/The Anh Tran/8. RNN/Flickr8k_text/Flickr_8k.trainImages.txt'\n","train = load_set(filename)\n","print('Dataset: %d' % len(train))"],"execution_count":179,"outputs":[{"output_type":"stream","text":["Dataset: 6000\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"O2afm-mDPW0K","executionInfo":{"status":"ok","timestamp":1628528899465,"user_tz":-420,"elapsed":515,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["# Folder chứa dữ liệu ảnh\n","images = '/content/drive/MyDrive/The Anh Tran/8. RNN/Flickr8k_Dataset/Flicker8k_Dataset/'\n","# Lấy các ảnh jpg trong thư mục\n","img = glob.glob(images + '*.jpg')"],"execution_count":180,"outputs":[]},{"cell_type":"code","metadata":{"id":"YwGPqPJFQ7ft","executionInfo":{"status":"ok","timestamp":1628528902240,"user_tz":-420,"elapsed":1,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["# File chứa id ảnh để train\n","train_images_file  = '/content/drive/MyDrive/The Anh Tran/8. RNN/Flickr8k_text/Flickr_8k.trainImages.txt'\n","# Read the train image names in a set\n","train_images = set(open(train_images_file, 'r').read().strip().split('\\n'))\n","\n","# Create a list of all the training images with their full path names\n","train_img = []\n","\n","for i in img: # img is list of full path names of all images\n","    if i[len(images):] in train_images: # Check if the image belongs to training set\n","        train_img.append(i) # Add it to the list of train images"],"execution_count":181,"outputs":[]},{"cell_type":"code","metadata":{"id":"g2DZTalSS5qw","executionInfo":{"status":"ok","timestamp":1628528904308,"user_tz":-420,"elapsed":3,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["test_images_file = '/content/drive/MyDrive/The Anh Tran/8. RNN/Flickr8k_text/Flickr_8k.testImages.txt'\n","test_images = set(open(test_images_file, 'r').read().strip().split('\\n'))\n","\n","# Create a list of all the test images with their full path names\n","test_img = []\n","\n","for i in img: # img is list of full path names of all images\n","    if i[len(images):] in test_images: # Check if the image belongs to test set\n","        test_img.append(i) # Add it to the list of test images"],"execution_count":182,"outputs":[]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"ewpYHbHPTfH5","executionInfo":{"status":"ok","timestamp":1628528906481,"user_tz":-420,"elapsed":661,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"57ebc635-7beb-483a-800f-064c03065c05"},"source":["# Thêm 'startseq', 'endseq' cho chuỗi\n","def load_clean_descriptions(filename, dataset):\n","\t# load document\n","\tdoc = load_doc(filename)\n","\tdescriptions = dict()\n","\tfor line in doc.split('\\n'):\n","\t\t# split line by white space\n","\t\ttokens = line.split()\n","\t\t# split id from description\n","\t\timage_id, image_desc = tokens[0], tokens[1:]\n","\t\t# skip images not in the set\n","\t\tif image_id in dataset:\n","\t\t\t# create list\n","\t\t\tif image_id not in descriptions:\n","\t\t\t\tdescriptions[image_id] = list()\n","\t\t\t# wrap description in tokens\n","\t\t\tdesc = 'startseq ' + ' '.join(image_desc) + ' endseq'\n","\t\t\t# store\n","\t\t\tdescriptions[image_id].append(desc)\n","\treturn descriptions\n","\n","train_descriptions = load_clean_description('/content/drive/MyDrive/The Anh Tran/8. RNN/descriptions.txt', train)\n","print('Descriptions: train = %d' %(len(train_descriptions)))"],"execution_count":183,"outputs":[{"output_type":"stream","text":["Descriptions: train = 6000\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"AhyqO1l6UVIG","executionInfo":{"status":"ok","timestamp":1628528909665,"user_tz":-420,"elapsed":529,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["# Load ảnh, resize về khích thước mà Inception v3 yêu cầu.\n","def preprocess(image_path):\n","    # Convert all the images to size 299x299 as expected by the inception v3 model\n","    img = image.load_img(image_path, target_size=(299, 299))\n","    # Convert PIL image to numpy array of 3-dimensions\n","    x = image.img_to_array(img)\n","    # Add one more dimension\n","    x = np.expand_dims(x, axis=0)\n","    # preprocess the images using preprocess_input() from inception module\n","    x = preprocess_input(x)\n","    return x"],"execution_count":184,"outputs":[]},{"cell_type":"code","metadata":{"id":"k4LikjtCWNoB","executionInfo":{"status":"ok","timestamp":1628528913182,"user_tz":-420,"elapsed":2335,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["# load model bor layer cuối\n","model = InceptionV3(weights='imagenet')"],"execution_count":185,"outputs":[]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"M13H9IacNRdB","executionInfo":{"status":"ok","timestamp":1628528914879,"user_tz":-420,"elapsed":4,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"24be2f17-b507-4490-a8a2-cb9379b2edc4"},"source":["model.summary()"],"execution_count":186,"outputs":[{"output_type":"stream","text":["Model: \"inception_v3\"\n","__________________________________________________________________________________________________\n","Layer (type)                    Output Shape         Param #     Connected to                     \n","==================================================================================================\n","input_16 (InputLayer)           [(None, 299, 299, 3) 0                                            \n","__________________________________________________________________________________________________\n","conv2d_188 (Conv2D)             (None, 149, 149, 32) 864         input_16[0][0]                   \n","__________________________________________________________________________________________________\n","batch_normalization_188 (BatchN (None, 149, 149, 32) 96          conv2d_188[0][0]                 \n","__________________________________________________________________________________________________\n","activation_188 (Activation)     (None, 149, 149, 32) 0           batch_normalization_188[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_189 (Conv2D)             (None, 147, 147, 32) 9216        activation_188[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_189 (BatchN (None, 147, 147, 32) 96          conv2d_189[0][0]                 \n","__________________________________________________________________________________________________\n","activation_189 (Activation)     (None, 147, 147, 32) 0           batch_normalization_189[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_190 (Conv2D)             (None, 147, 147, 64) 18432       activation_189[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_190 (BatchN (None, 147, 147, 64) 192         conv2d_190[0][0]                 \n","__________________________________________________________________________________________________\n","activation_190 (Activation)     (None, 147, 147, 64) 0           batch_normalization_190[0][0]    \n","__________________________________________________________________________________________________\n","max_pooling2d_8 (MaxPooling2D)  (None, 73, 73, 64)   0           activation_190[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_191 (Conv2D)             (None, 73, 73, 80)   5120        max_pooling2d_8[0][0]            \n","__________________________________________________________________________________________________\n","batch_normalization_191 (BatchN (None, 73, 73, 80)   240         conv2d_191[0][0]                 \n","__________________________________________________________________________________________________\n","activation_191 (Activation)     (None, 73, 73, 80)   0           batch_normalization_191[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_192 (Conv2D)             (None, 71, 71, 192)  138240      activation_191[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_192 (BatchN (None, 71, 71, 192)  576         conv2d_192[0][0]                 \n","__________________________________________________________________________________________________\n","activation_192 (Activation)     (None, 71, 71, 192)  0           batch_normalization_192[0][0]    \n","__________________________________________________________________________________________________\n","max_pooling2d_9 (MaxPooling2D)  (None, 35, 35, 192)  0           activation_192[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_196 (Conv2D)             (None, 35, 35, 64)   12288       max_pooling2d_9[0][0]            \n","__________________________________________________________________________________________________\n","batch_normalization_196 (BatchN (None, 35, 35, 64)   192         conv2d_196[0][0]                 \n","__________________________________________________________________________________________________\n","activation_196 (Activation)     (None, 35, 35, 64)   0           batch_normalization_196[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_194 (Conv2D)             (None, 35, 35, 48)   9216        max_pooling2d_9[0][0]            \n","__________________________________________________________________________________________________\n","conv2d_197 (Conv2D)             (None, 35, 35, 96)   55296       activation_196[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_194 (BatchN (None, 35, 35, 48)   144         conv2d_194[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_197 (BatchN (None, 35, 35, 96)   288         conv2d_197[0][0]                 \n","__________________________________________________________________________________________________\n","activation_194 (Activation)     (None, 35, 35, 48)   0           batch_normalization_194[0][0]    \n","__________________________________________________________________________________________________\n","activation_197 (Activation)     (None, 35, 35, 96)   0           batch_normalization_197[0][0]    \n","__________________________________________________________________________________________________\n","average_pooling2d_18 (AveragePo (None, 35, 35, 192)  0           max_pooling2d_9[0][0]            \n","__________________________________________________________________________________________________\n","conv2d_193 (Conv2D)             (None, 35, 35, 64)   12288       max_pooling2d_9[0][0]            \n","__________________________________________________________________________________________________\n","conv2d_195 (Conv2D)             (None, 35, 35, 64)   76800       activation_194[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_198 (Conv2D)             (None, 35, 35, 96)   82944       activation_197[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_199 (Conv2D)             (None, 35, 35, 32)   6144        average_pooling2d_18[0][0]       \n","__________________________________________________________________________________________________\n","batch_normalization_193 (BatchN (None, 35, 35, 64)   192         conv2d_193[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_195 (BatchN (None, 35, 35, 64)   192         conv2d_195[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_198 (BatchN (None, 35, 35, 96)   288         conv2d_198[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_199 (BatchN (None, 35, 35, 32)   96          conv2d_199[0][0]                 \n","__________________________________________________________________________________________________\n","activation_193 (Activation)     (None, 35, 35, 64)   0           batch_normalization_193[0][0]    \n","__________________________________________________________________________________________________\n","activation_195 (Activation)     (None, 35, 35, 64)   0           batch_normalization_195[0][0]    \n","__________________________________________________________________________________________________\n","activation_198 (Activation)     (None, 35, 35, 96)   0           batch_normalization_198[0][0]    \n","__________________________________________________________________________________________________\n","activation_199 (Activation)     (None, 35, 35, 32)   0           batch_normalization_199[0][0]    \n","__________________________________________________________________________________________________\n","mixed0 (Concatenate)            (None, 35, 35, 256)  0           activation_193[0][0]             \n","                                                                 activation_195[0][0]             \n","                                                                 activation_198[0][0]             \n","                                                                 activation_199[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_203 (Conv2D)             (None, 35, 35, 64)   16384       mixed0[0][0]                     \n","__________________________________________________________________________________________________\n","batch_normalization_203 (BatchN (None, 35, 35, 64)   192         conv2d_203[0][0]                 \n","__________________________________________________________________________________________________\n","activation_203 (Activation)     (None, 35, 35, 64)   0           batch_normalization_203[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_201 (Conv2D)             (None, 35, 35, 48)   12288       mixed0[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_204 (Conv2D)             (None, 35, 35, 96)   55296       activation_203[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_201 (BatchN (None, 35, 35, 48)   144         conv2d_201[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_204 (BatchN (None, 35, 35, 96)   288         conv2d_204[0][0]                 \n","__________________________________________________________________________________________________\n","activation_201 (Activation)     (None, 35, 35, 48)   0           batch_normalization_201[0][0]    \n","__________________________________________________________________________________________________\n","activation_204 (Activation)     (None, 35, 35, 96)   0           batch_normalization_204[0][0]    \n","__________________________________________________________________________________________________\n","average_pooling2d_19 (AveragePo (None, 35, 35, 256)  0           mixed0[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_200 (Conv2D)             (None, 35, 35, 64)   16384       mixed0[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_202 (Conv2D)             (None, 35, 35, 64)   76800       activation_201[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_205 (Conv2D)             (None, 35, 35, 96)   82944       activation_204[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_206 (Conv2D)             (None, 35, 35, 64)   16384       average_pooling2d_19[0][0]       \n","__________________________________________________________________________________________________\n","batch_normalization_200 (BatchN (None, 35, 35, 64)   192         conv2d_200[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_202 (BatchN (None, 35, 35, 64)   192         conv2d_202[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_205 (BatchN (None, 35, 35, 96)   288         conv2d_205[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_206 (BatchN (None, 35, 35, 64)   192         conv2d_206[0][0]                 \n","__________________________________________________________________________________________________\n","activation_200 (Activation)     (None, 35, 35, 64)   0           batch_normalization_200[0][0]    \n","__________________________________________________________________________________________________\n","activation_202 (Activation)     (None, 35, 35, 64)   0           batch_normalization_202[0][0]    \n","__________________________________________________________________________________________________\n","activation_205 (Activation)     (None, 35, 35, 96)   0           batch_normalization_205[0][0]    \n","__________________________________________________________________________________________________\n","activation_206 (Activation)     (None, 35, 35, 64)   0           batch_normalization_206[0][0]    \n","__________________________________________________________________________________________________\n","mixed1 (Concatenate)            (None, 35, 35, 288)  0           activation_200[0][0]             \n","                                                                 activation_202[0][0]             \n","                                                                 activation_205[0][0]             \n","                                                                 activation_206[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_210 (Conv2D)             (None, 35, 35, 64)   18432       mixed1[0][0]                     \n","__________________________________________________________________________________________________\n","batch_normalization_210 (BatchN (None, 35, 35, 64)   192         conv2d_210[0][0]                 \n","__________________________________________________________________________________________________\n","activation_210 (Activation)     (None, 35, 35, 64)   0           batch_normalization_210[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_208 (Conv2D)             (None, 35, 35, 48)   13824       mixed1[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_211 (Conv2D)             (None, 35, 35, 96)   55296       activation_210[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_208 (BatchN (None, 35, 35, 48)   144         conv2d_208[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_211 (BatchN (None, 35, 35, 96)   288         conv2d_211[0][0]                 \n","__________________________________________________________________________________________________\n","activation_208 (Activation)     (None, 35, 35, 48)   0           batch_normalization_208[0][0]    \n","__________________________________________________________________________________________________\n","activation_211 (Activation)     (None, 35, 35, 96)   0           batch_normalization_211[0][0]    \n","__________________________________________________________________________________________________\n","average_pooling2d_20 (AveragePo (None, 35, 35, 288)  0           mixed1[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_207 (Conv2D)             (None, 35, 35, 64)   18432       mixed1[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_209 (Conv2D)             (None, 35, 35, 64)   76800       activation_208[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_212 (Conv2D)             (None, 35, 35, 96)   82944       activation_211[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_213 (Conv2D)             (None, 35, 35, 64)   18432       average_pooling2d_20[0][0]       \n","__________________________________________________________________________________________________\n","batch_normalization_207 (BatchN (None, 35, 35, 64)   192         conv2d_207[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_209 (BatchN (None, 35, 35, 64)   192         conv2d_209[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_212 (BatchN (None, 35, 35, 96)   288         conv2d_212[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_213 (BatchN (None, 35, 35, 64)   192         conv2d_213[0][0]                 \n","__________________________________________________________________________________________________\n","activation_207 (Activation)     (None, 35, 35, 64)   0           batch_normalization_207[0][0]    \n","__________________________________________________________________________________________________\n","activation_209 (Activation)     (None, 35, 35, 64)   0           batch_normalization_209[0][0]    \n","__________________________________________________________________________________________________\n","activation_212 (Activation)     (None, 35, 35, 96)   0           batch_normalization_212[0][0]    \n","__________________________________________________________________________________________________\n","activation_213 (Activation)     (None, 35, 35, 64)   0           batch_normalization_213[0][0]    \n","__________________________________________________________________________________________________\n","mixed2 (Concatenate)            (None, 35, 35, 288)  0           activation_207[0][0]             \n","                                                                 activation_209[0][0]             \n","                                                                 activation_212[0][0]             \n","                                                                 activation_213[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_215 (Conv2D)             (None, 35, 35, 64)   18432       mixed2[0][0]                     \n","__________________________________________________________________________________________________\n","batch_normalization_215 (BatchN (None, 35, 35, 64)   192         conv2d_215[0][0]                 \n","__________________________________________________________________________________________________\n","activation_215 (Activation)     (None, 35, 35, 64)   0           batch_normalization_215[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_216 (Conv2D)             (None, 35, 35, 96)   55296       activation_215[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_216 (BatchN (None, 35, 35, 96)   288         conv2d_216[0][0]                 \n","__________________________________________________________________________________________________\n","activation_216 (Activation)     (None, 35, 35, 96)   0           batch_normalization_216[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_214 (Conv2D)             (None, 17, 17, 384)  995328      mixed2[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_217 (Conv2D)             (None, 17, 17, 96)   82944       activation_216[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_214 (BatchN (None, 17, 17, 384)  1152        conv2d_214[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_217 (BatchN (None, 17, 17, 96)   288         conv2d_217[0][0]                 \n","__________________________________________________________________________________________________\n","activation_214 (Activation)     (None, 17, 17, 384)  0           batch_normalization_214[0][0]    \n","__________________________________________________________________________________________________\n","activation_217 (Activation)     (None, 17, 17, 96)   0           batch_normalization_217[0][0]    \n","__________________________________________________________________________________________________\n","max_pooling2d_10 (MaxPooling2D) (None, 17, 17, 288)  0           mixed2[0][0]                     \n","__________________________________________________________________________________________________\n","mixed3 (Concatenate)            (None, 17, 17, 768)  0           activation_214[0][0]             \n","                                                                 activation_217[0][0]             \n","                                                                 max_pooling2d_10[0][0]           \n","__________________________________________________________________________________________________\n","conv2d_222 (Conv2D)             (None, 17, 17, 128)  98304       mixed3[0][0]                     \n","__________________________________________________________________________________________________\n","batch_normalization_222 (BatchN (None, 17, 17, 128)  384         conv2d_222[0][0]                 \n","__________________________________________________________________________________________________\n","activation_222 (Activation)     (None, 17, 17, 128)  0           batch_normalization_222[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_223 (Conv2D)             (None, 17, 17, 128)  114688      activation_222[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_223 (BatchN (None, 17, 17, 128)  384         conv2d_223[0][0]                 \n","__________________________________________________________________________________________________\n","activation_223 (Activation)     (None, 17, 17, 128)  0           batch_normalization_223[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_219 (Conv2D)             (None, 17, 17, 128)  98304       mixed3[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_224 (Conv2D)             (None, 17, 17, 128)  114688      activation_223[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_219 (BatchN (None, 17, 17, 128)  384         conv2d_219[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_224 (BatchN (None, 17, 17, 128)  384         conv2d_224[0][0]                 \n","__________________________________________________________________________________________________\n","activation_219 (Activation)     (None, 17, 17, 128)  0           batch_normalization_219[0][0]    \n","__________________________________________________________________________________________________\n","activation_224 (Activation)     (None, 17, 17, 128)  0           batch_normalization_224[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_220 (Conv2D)             (None, 17, 17, 128)  114688      activation_219[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_225 (Conv2D)             (None, 17, 17, 128)  114688      activation_224[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_220 (BatchN (None, 17, 17, 128)  384         conv2d_220[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_225 (BatchN (None, 17, 17, 128)  384         conv2d_225[0][0]                 \n","__________________________________________________________________________________________________\n","activation_220 (Activation)     (None, 17, 17, 128)  0           batch_normalization_220[0][0]    \n","__________________________________________________________________________________________________\n","activation_225 (Activation)     (None, 17, 17, 128)  0           batch_normalization_225[0][0]    \n","__________________________________________________________________________________________________\n","average_pooling2d_21 (AveragePo (None, 17, 17, 768)  0           mixed3[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_218 (Conv2D)             (None, 17, 17, 192)  147456      mixed3[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_221 (Conv2D)             (None, 17, 17, 192)  172032      activation_220[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_226 (Conv2D)             (None, 17, 17, 192)  172032      activation_225[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_227 (Conv2D)             (None, 17, 17, 192)  147456      average_pooling2d_21[0][0]       \n","__________________________________________________________________________________________________\n","batch_normalization_218 (BatchN (None, 17, 17, 192)  576         conv2d_218[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_221 (BatchN (None, 17, 17, 192)  576         conv2d_221[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_226 (BatchN (None, 17, 17, 192)  576         conv2d_226[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_227 (BatchN (None, 17, 17, 192)  576         conv2d_227[0][0]                 \n","__________________________________________________________________________________________________\n","activation_218 (Activation)     (None, 17, 17, 192)  0           batch_normalization_218[0][0]    \n","__________________________________________________________________________________________________\n","activation_221 (Activation)     (None, 17, 17, 192)  0           batch_normalization_221[0][0]    \n","__________________________________________________________________________________________________\n","activation_226 (Activation)     (None, 17, 17, 192)  0           batch_normalization_226[0][0]    \n","__________________________________________________________________________________________________\n","activation_227 (Activation)     (None, 17, 17, 192)  0           batch_normalization_227[0][0]    \n","__________________________________________________________________________________________________\n","mixed4 (Concatenate)            (None, 17, 17, 768)  0           activation_218[0][0]             \n","                                                                 activation_221[0][0]             \n","                                                                 activation_226[0][0]             \n","                                                                 activation_227[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_232 (Conv2D)             (None, 17, 17, 160)  122880      mixed4[0][0]                     \n","__________________________________________________________________________________________________\n","batch_normalization_232 (BatchN (None, 17, 17, 160)  480         conv2d_232[0][0]                 \n","__________________________________________________________________________________________________\n","activation_232 (Activation)     (None, 17, 17, 160)  0           batch_normalization_232[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_233 (Conv2D)             (None, 17, 17, 160)  179200      activation_232[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_233 (BatchN (None, 17, 17, 160)  480         conv2d_233[0][0]                 \n","__________________________________________________________________________________________________\n","activation_233 (Activation)     (None, 17, 17, 160)  0           batch_normalization_233[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_229 (Conv2D)             (None, 17, 17, 160)  122880      mixed4[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_234 (Conv2D)             (None, 17, 17, 160)  179200      activation_233[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_229 (BatchN (None, 17, 17, 160)  480         conv2d_229[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_234 (BatchN (None, 17, 17, 160)  480         conv2d_234[0][0]                 \n","__________________________________________________________________________________________________\n","activation_229 (Activation)     (None, 17, 17, 160)  0           batch_normalization_229[0][0]    \n","__________________________________________________________________________________________________\n","activation_234 (Activation)     (None, 17, 17, 160)  0           batch_normalization_234[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_230 (Conv2D)             (None, 17, 17, 160)  179200      activation_229[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_235 (Conv2D)             (None, 17, 17, 160)  179200      activation_234[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_230 (BatchN (None, 17, 17, 160)  480         conv2d_230[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_235 (BatchN (None, 17, 17, 160)  480         conv2d_235[0][0]                 \n","__________________________________________________________________________________________________\n","activation_230 (Activation)     (None, 17, 17, 160)  0           batch_normalization_230[0][0]    \n","__________________________________________________________________________________________________\n","activation_235 (Activation)     (None, 17, 17, 160)  0           batch_normalization_235[0][0]    \n","__________________________________________________________________________________________________\n","average_pooling2d_22 (AveragePo (None, 17, 17, 768)  0           mixed4[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_228 (Conv2D)             (None, 17, 17, 192)  147456      mixed4[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_231 (Conv2D)             (None, 17, 17, 192)  215040      activation_230[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_236 (Conv2D)             (None, 17, 17, 192)  215040      activation_235[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_237 (Conv2D)             (None, 17, 17, 192)  147456      average_pooling2d_22[0][0]       \n","__________________________________________________________________________________________________\n","batch_normalization_228 (BatchN (None, 17, 17, 192)  576         conv2d_228[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_231 (BatchN (None, 17, 17, 192)  576         conv2d_231[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_236 (BatchN (None, 17, 17, 192)  576         conv2d_236[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_237 (BatchN (None, 17, 17, 192)  576         conv2d_237[0][0]                 \n","__________________________________________________________________________________________________\n","activation_228 (Activation)     (None, 17, 17, 192)  0           batch_normalization_228[0][0]    \n","__________________________________________________________________________________________________\n","activation_231 (Activation)     (None, 17, 17, 192)  0           batch_normalization_231[0][0]    \n","__________________________________________________________________________________________________\n","activation_236 (Activation)     (None, 17, 17, 192)  0           batch_normalization_236[0][0]    \n","__________________________________________________________________________________________________\n","activation_237 (Activation)     (None, 17, 17, 192)  0           batch_normalization_237[0][0]    \n","__________________________________________________________________________________________________\n","mixed5 (Concatenate)            (None, 17, 17, 768)  0           activation_228[0][0]             \n","                                                                 activation_231[0][0]             \n","                                                                 activation_236[0][0]             \n","                                                                 activation_237[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_242 (Conv2D)             (None, 17, 17, 160)  122880      mixed5[0][0]                     \n","__________________________________________________________________________________________________\n","batch_normalization_242 (BatchN (None, 17, 17, 160)  480         conv2d_242[0][0]                 \n","__________________________________________________________________________________________________\n","activation_242 (Activation)     (None, 17, 17, 160)  0           batch_normalization_242[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_243 (Conv2D)             (None, 17, 17, 160)  179200      activation_242[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_243 (BatchN (None, 17, 17, 160)  480         conv2d_243[0][0]                 \n","__________________________________________________________________________________________________\n","activation_243 (Activation)     (None, 17, 17, 160)  0           batch_normalization_243[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_239 (Conv2D)             (None, 17, 17, 160)  122880      mixed5[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_244 (Conv2D)             (None, 17, 17, 160)  179200      activation_243[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_239 (BatchN (None, 17, 17, 160)  480         conv2d_239[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_244 (BatchN (None, 17, 17, 160)  480         conv2d_244[0][0]                 \n","__________________________________________________________________________________________________\n","activation_239 (Activation)     (None, 17, 17, 160)  0           batch_normalization_239[0][0]    \n","__________________________________________________________________________________________________\n","activation_244 (Activation)     (None, 17, 17, 160)  0           batch_normalization_244[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_240 (Conv2D)             (None, 17, 17, 160)  179200      activation_239[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_245 (Conv2D)             (None, 17, 17, 160)  179200      activation_244[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_240 (BatchN (None, 17, 17, 160)  480         conv2d_240[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_245 (BatchN (None, 17, 17, 160)  480         conv2d_245[0][0]                 \n","__________________________________________________________________________________________________\n","activation_240 (Activation)     (None, 17, 17, 160)  0           batch_normalization_240[0][0]    \n","__________________________________________________________________________________________________\n","activation_245 (Activation)     (None, 17, 17, 160)  0           batch_normalization_245[0][0]    \n","__________________________________________________________________________________________________\n","average_pooling2d_23 (AveragePo (None, 17, 17, 768)  0           mixed5[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_238 (Conv2D)             (None, 17, 17, 192)  147456      mixed5[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_241 (Conv2D)             (None, 17, 17, 192)  215040      activation_240[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_246 (Conv2D)             (None, 17, 17, 192)  215040      activation_245[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_247 (Conv2D)             (None, 17, 17, 192)  147456      average_pooling2d_23[0][0]       \n","__________________________________________________________________________________________________\n","batch_normalization_238 (BatchN (None, 17, 17, 192)  576         conv2d_238[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_241 (BatchN (None, 17, 17, 192)  576         conv2d_241[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_246 (BatchN (None, 17, 17, 192)  576         conv2d_246[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_247 (BatchN (None, 17, 17, 192)  576         conv2d_247[0][0]                 \n","__________________________________________________________________________________________________\n","activation_238 (Activation)     (None, 17, 17, 192)  0           batch_normalization_238[0][0]    \n","__________________________________________________________________________________________________\n","activation_241 (Activation)     (None, 17, 17, 192)  0           batch_normalization_241[0][0]    \n","__________________________________________________________________________________________________\n","activation_246 (Activation)     (None, 17, 17, 192)  0           batch_normalization_246[0][0]    \n","__________________________________________________________________________________________________\n","activation_247 (Activation)     (None, 17, 17, 192)  0           batch_normalization_247[0][0]    \n","__________________________________________________________________________________________________\n","mixed6 (Concatenate)            (None, 17, 17, 768)  0           activation_238[0][0]             \n","                                                                 activation_241[0][0]             \n","                                                                 activation_246[0][0]             \n","                                                                 activation_247[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_252 (Conv2D)             (None, 17, 17, 192)  147456      mixed6[0][0]                     \n","__________________________________________________________________________________________________\n","batch_normalization_252 (BatchN (None, 17, 17, 192)  576         conv2d_252[0][0]                 \n","__________________________________________________________________________________________________\n","activation_252 (Activation)     (None, 17, 17, 192)  0           batch_normalization_252[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_253 (Conv2D)             (None, 17, 17, 192)  258048      activation_252[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_253 (BatchN (None, 17, 17, 192)  576         conv2d_253[0][0]                 \n","__________________________________________________________________________________________________\n","activation_253 (Activation)     (None, 17, 17, 192)  0           batch_normalization_253[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_249 (Conv2D)             (None, 17, 17, 192)  147456      mixed6[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_254 (Conv2D)             (None, 17, 17, 192)  258048      activation_253[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_249 (BatchN (None, 17, 17, 192)  576         conv2d_249[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_254 (BatchN (None, 17, 17, 192)  576         conv2d_254[0][0]                 \n","__________________________________________________________________________________________________\n","activation_249 (Activation)     (None, 17, 17, 192)  0           batch_normalization_249[0][0]    \n","__________________________________________________________________________________________________\n","activation_254 (Activation)     (None, 17, 17, 192)  0           batch_normalization_254[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_250 (Conv2D)             (None, 17, 17, 192)  258048      activation_249[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_255 (Conv2D)             (None, 17, 17, 192)  258048      activation_254[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_250 (BatchN (None, 17, 17, 192)  576         conv2d_250[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_255 (BatchN (None, 17, 17, 192)  576         conv2d_255[0][0]                 \n","__________________________________________________________________________________________________\n","activation_250 (Activation)     (None, 17, 17, 192)  0           batch_normalization_250[0][0]    \n","__________________________________________________________________________________________________\n","activation_255 (Activation)     (None, 17, 17, 192)  0           batch_normalization_255[0][0]    \n","__________________________________________________________________________________________________\n","average_pooling2d_24 (AveragePo (None, 17, 17, 768)  0           mixed6[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_248 (Conv2D)             (None, 17, 17, 192)  147456      mixed6[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_251 (Conv2D)             (None, 17, 17, 192)  258048      activation_250[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_256 (Conv2D)             (None, 17, 17, 192)  258048      activation_255[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_257 (Conv2D)             (None, 17, 17, 192)  147456      average_pooling2d_24[0][0]       \n","__________________________________________________________________________________________________\n","batch_normalization_248 (BatchN (None, 17, 17, 192)  576         conv2d_248[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_251 (BatchN (None, 17, 17, 192)  576         conv2d_251[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_256 (BatchN (None, 17, 17, 192)  576         conv2d_256[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_257 (BatchN (None, 17, 17, 192)  576         conv2d_257[0][0]                 \n","__________________________________________________________________________________________________\n","activation_248 (Activation)     (None, 17, 17, 192)  0           batch_normalization_248[0][0]    \n","__________________________________________________________________________________________________\n","activation_251 (Activation)     (None, 17, 17, 192)  0           batch_normalization_251[0][0]    \n","__________________________________________________________________________________________________\n","activation_256 (Activation)     (None, 17, 17, 192)  0           batch_normalization_256[0][0]    \n","__________________________________________________________________________________________________\n","activation_257 (Activation)     (None, 17, 17, 192)  0           batch_normalization_257[0][0]    \n","__________________________________________________________________________________________________\n","mixed7 (Concatenate)            (None, 17, 17, 768)  0           activation_248[0][0]             \n","                                                                 activation_251[0][0]             \n","                                                                 activation_256[0][0]             \n","                                                                 activation_257[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_260 (Conv2D)             (None, 17, 17, 192)  147456      mixed7[0][0]                     \n","__________________________________________________________________________________________________\n","batch_normalization_260 (BatchN (None, 17, 17, 192)  576         conv2d_260[0][0]                 \n","__________________________________________________________________________________________________\n","activation_260 (Activation)     (None, 17, 17, 192)  0           batch_normalization_260[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_261 (Conv2D)             (None, 17, 17, 192)  258048      activation_260[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_261 (BatchN (None, 17, 17, 192)  576         conv2d_261[0][0]                 \n","__________________________________________________________________________________________________\n","activation_261 (Activation)     (None, 17, 17, 192)  0           batch_normalization_261[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_258 (Conv2D)             (None, 17, 17, 192)  147456      mixed7[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_262 (Conv2D)             (None, 17, 17, 192)  258048      activation_261[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_258 (BatchN (None, 17, 17, 192)  576         conv2d_258[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_262 (BatchN (None, 17, 17, 192)  576         conv2d_262[0][0]                 \n","__________________________________________________________________________________________________\n","activation_258 (Activation)     (None, 17, 17, 192)  0           batch_normalization_258[0][0]    \n","__________________________________________________________________________________________________\n","activation_262 (Activation)     (None, 17, 17, 192)  0           batch_normalization_262[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_259 (Conv2D)             (None, 8, 8, 320)    552960      activation_258[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_263 (Conv2D)             (None, 8, 8, 192)    331776      activation_262[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_259 (BatchN (None, 8, 8, 320)    960         conv2d_259[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_263 (BatchN (None, 8, 8, 192)    576         conv2d_263[0][0]                 \n","__________________________________________________________________________________________________\n","activation_259 (Activation)     (None, 8, 8, 320)    0           batch_normalization_259[0][0]    \n","__________________________________________________________________________________________________\n","activation_263 (Activation)     (None, 8, 8, 192)    0           batch_normalization_263[0][0]    \n","__________________________________________________________________________________________________\n","max_pooling2d_11 (MaxPooling2D) (None, 8, 8, 768)    0           mixed7[0][0]                     \n","__________________________________________________________________________________________________\n","mixed8 (Concatenate)            (None, 8, 8, 1280)   0           activation_259[0][0]             \n","                                                                 activation_263[0][0]             \n","                                                                 max_pooling2d_11[0][0]           \n","__________________________________________________________________________________________________\n","conv2d_268 (Conv2D)             (None, 8, 8, 448)    573440      mixed8[0][0]                     \n","__________________________________________________________________________________________________\n","batch_normalization_268 (BatchN (None, 8, 8, 448)    1344        conv2d_268[0][0]                 \n","__________________________________________________________________________________________________\n","activation_268 (Activation)     (None, 8, 8, 448)    0           batch_normalization_268[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_265 (Conv2D)             (None, 8, 8, 384)    491520      mixed8[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_269 (Conv2D)             (None, 8, 8, 384)    1548288     activation_268[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_265 (BatchN (None, 8, 8, 384)    1152        conv2d_265[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_269 (BatchN (None, 8, 8, 384)    1152        conv2d_269[0][0]                 \n","__________________________________________________________________________________________________\n","activation_265 (Activation)     (None, 8, 8, 384)    0           batch_normalization_265[0][0]    \n","__________________________________________________________________________________________________\n","activation_269 (Activation)     (None, 8, 8, 384)    0           batch_normalization_269[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_266 (Conv2D)             (None, 8, 8, 384)    442368      activation_265[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_267 (Conv2D)             (None, 8, 8, 384)    442368      activation_265[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_270 (Conv2D)             (None, 8, 8, 384)    442368      activation_269[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_271 (Conv2D)             (None, 8, 8, 384)    442368      activation_269[0][0]             \n","__________________________________________________________________________________________________\n","average_pooling2d_25 (AveragePo (None, 8, 8, 1280)   0           mixed8[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_264 (Conv2D)             (None, 8, 8, 320)    409600      mixed8[0][0]                     \n","__________________________________________________________________________________________________\n","batch_normalization_266 (BatchN (None, 8, 8, 384)    1152        conv2d_266[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_267 (BatchN (None, 8, 8, 384)    1152        conv2d_267[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_270 (BatchN (None, 8, 8, 384)    1152        conv2d_270[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_271 (BatchN (None, 8, 8, 384)    1152        conv2d_271[0][0]                 \n","__________________________________________________________________________________________________\n","conv2d_272 (Conv2D)             (None, 8, 8, 192)    245760      average_pooling2d_25[0][0]       \n","__________________________________________________________________________________________________\n","batch_normalization_264 (BatchN (None, 8, 8, 320)    960         conv2d_264[0][0]                 \n","__________________________________________________________________________________________________\n","activation_266 (Activation)     (None, 8, 8, 384)    0           batch_normalization_266[0][0]    \n","__________________________________________________________________________________________________\n","activation_267 (Activation)     (None, 8, 8, 384)    0           batch_normalization_267[0][0]    \n","__________________________________________________________________________________________________\n","activation_270 (Activation)     (None, 8, 8, 384)    0           batch_normalization_270[0][0]    \n","__________________________________________________________________________________________________\n","activation_271 (Activation)     (None, 8, 8, 384)    0           batch_normalization_271[0][0]    \n","__________________________________________________________________________________________________\n","batch_normalization_272 (BatchN (None, 8, 8, 192)    576         conv2d_272[0][0]                 \n","__________________________________________________________________________________________________\n","activation_264 (Activation)     (None, 8, 8, 320)    0           batch_normalization_264[0][0]    \n","__________________________________________________________________________________________________\n","mixed9_0 (Concatenate)          (None, 8, 8, 768)    0           activation_266[0][0]             \n","                                                                 activation_267[0][0]             \n","__________________________________________________________________________________________________\n","concatenate_4 (Concatenate)     (None, 8, 8, 768)    0           activation_270[0][0]             \n","                                                                 activation_271[0][0]             \n","__________________________________________________________________________________________________\n","activation_272 (Activation)     (None, 8, 8, 192)    0           batch_normalization_272[0][0]    \n","__________________________________________________________________________________________________\n","mixed9 (Concatenate)            (None, 8, 8, 2048)   0           activation_264[0][0]             \n","                                                                 mixed9_0[0][0]                   \n","                                                                 concatenate_4[0][0]              \n","                                                                 activation_272[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_277 (Conv2D)             (None, 8, 8, 448)    917504      mixed9[0][0]                     \n","__________________________________________________________________________________________________\n","batch_normalization_277 (BatchN (None, 8, 8, 448)    1344        conv2d_277[0][0]                 \n","__________________________________________________________________________________________________\n","activation_277 (Activation)     (None, 8, 8, 448)    0           batch_normalization_277[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_274 (Conv2D)             (None, 8, 8, 384)    786432      mixed9[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_278 (Conv2D)             (None, 8, 8, 384)    1548288     activation_277[0][0]             \n","__________________________________________________________________________________________________\n","batch_normalization_274 (BatchN (None, 8, 8, 384)    1152        conv2d_274[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_278 (BatchN (None, 8, 8, 384)    1152        conv2d_278[0][0]                 \n","__________________________________________________________________________________________________\n","activation_274 (Activation)     (None, 8, 8, 384)    0           batch_normalization_274[0][0]    \n","__________________________________________________________________________________________________\n","activation_278 (Activation)     (None, 8, 8, 384)    0           batch_normalization_278[0][0]    \n","__________________________________________________________________________________________________\n","conv2d_275 (Conv2D)             (None, 8, 8, 384)    442368      activation_274[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_276 (Conv2D)             (None, 8, 8, 384)    442368      activation_274[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_279 (Conv2D)             (None, 8, 8, 384)    442368      activation_278[0][0]             \n","__________________________________________________________________________________________________\n","conv2d_280 (Conv2D)             (None, 8, 8, 384)    442368      activation_278[0][0]             \n","__________________________________________________________________________________________________\n","average_pooling2d_26 (AveragePo (None, 8, 8, 2048)   0           mixed9[0][0]                     \n","__________________________________________________________________________________________________\n","conv2d_273 (Conv2D)             (None, 8, 8, 320)    655360      mixed9[0][0]                     \n","__________________________________________________________________________________________________\n","batch_normalization_275 (BatchN (None, 8, 8, 384)    1152        conv2d_275[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_276 (BatchN (None, 8, 8, 384)    1152        conv2d_276[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_279 (BatchN (None, 8, 8, 384)    1152        conv2d_279[0][0]                 \n","__________________________________________________________________________________________________\n","batch_normalization_280 (BatchN (None, 8, 8, 384)    1152        conv2d_280[0][0]                 \n","__________________________________________________________________________________________________\n","conv2d_281 (Conv2D)             (None, 8, 8, 192)    393216      average_pooling2d_26[0][0]       \n","__________________________________________________________________________________________________\n","batch_normalization_273 (BatchN (None, 8, 8, 320)    960         conv2d_273[0][0]                 \n","__________________________________________________________________________________________________\n","activation_275 (Activation)     (None, 8, 8, 384)    0           batch_normalization_275[0][0]    \n","__________________________________________________________________________________________________\n","activation_276 (Activation)     (None, 8, 8, 384)    0           batch_normalization_276[0][0]    \n","__________________________________________________________________________________________________\n","activation_279 (Activation)     (None, 8, 8, 384)    0           batch_normalization_279[0][0]    \n","__________________________________________________________________________________________________\n","activation_280 (Activation)     (None, 8, 8, 384)    0           batch_normalization_280[0][0]    \n","__________________________________________________________________________________________________\n","batch_normalization_281 (BatchN (None, 8, 8, 192)    576         conv2d_281[0][0]                 \n","__________________________________________________________________________________________________\n","activation_273 (Activation)     (None, 8, 8, 320)    0           batch_normalization_273[0][0]    \n","__________________________________________________________________________________________________\n","mixed9_1 (Concatenate)          (None, 8, 8, 768)    0           activation_275[0][0]             \n","                                                                 activation_276[0][0]             \n","__________________________________________________________________________________________________\n","concatenate_5 (Concatenate)     (None, 8, 8, 768)    0           activation_279[0][0]             \n","                                                                 activation_280[0][0]             \n","__________________________________________________________________________________________________\n","activation_281 (Activation)     (None, 8, 8, 192)    0           batch_normalization_281[0][0]    \n","__________________________________________________________________________________________________\n","mixed10 (Concatenate)           (None, 8, 8, 2048)   0           activation_273[0][0]             \n","                                                                 mixed9_1[0][0]                   \n","                                                                 concatenate_5[0][0]              \n","                                                                 activation_281[0][0]             \n","__________________________________________________________________________________________________\n","avg_pool (GlobalAveragePooling2 (None, 2048)         0           mixed10[0][0]                    \n","__________________________________________________________________________________________________\n","predictions (Dense)             (None, 1000)         2049000     avg_pool[0][0]                   \n","==================================================================================================\n","Total params: 23,851,784\n","Trainable params: 23,817,352\n","Non-trainable params: 34,432\n","__________________________________________________________________________________________________\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"Xr_eBU6vYD6O","executionInfo":{"status":"ok","timestamp":1628528917562,"user_tz":-420,"elapsed":466,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["# Tạo model mới, bỏ layer cuối từ inception v3\n","model_new = Model(model.input, model.layers[-2].output)"],"execution_count":187,"outputs":[]},{"cell_type":"code","metadata":{"id":"y0WCmnymWS-f","executionInfo":{"status":"ok","timestamp":1628528918925,"user_tz":-420,"elapsed":2,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["# Image embedding thành vector (2048, )\n","def encode(image):\n","    image = preprocess(image) # preprocess the image\n","    fea_vec = model_new.predict(image) # Get the encoding vector for the image\n","    fea_vec = np.reshape(fea_vec, fea_vec.shape[1]) # reshape from (1, 2048) to (2048, )\n","    return fea_vec"],"execution_count":188,"outputs":[]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/","height":158,"referenced_widgets":["8ece86adbe9144e8a80302b081fcd68f","6e91bf4c7dfc4c4da9a0b10124c9488a","3c4b72e94d65409c802eccfc7ebc87aa","e84269a29ad24999ac89e9db115a2e73","8c7721b634d74e21b742582547ac43b5","9f949ebb958d4ee7b6787fc8264d8a22","3db02d7e07024352b4a379e1f7db79ef","7cf88927095649ccaa100d7cae1418a9"]},"id":"RPWAJJTUXE0-","executionInfo":{"status":"ok","timestamp":1628529567833,"user_tz":-420,"elapsed":626372,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"b8f1ff9c-b186-4e5a-e914-a987ec2f6a2e"},"source":["# Gọi hàm encode với các ảnh trong traning set\n","start = time()\n","encoding_train = {}\n","for img in tqdm_notebook(train_img):\n","    encoding_train[img[len(images):]] = encode(img)\n","print(\"Time taken in seconds =\", time()-start)"],"execution_count":190,"outputs":[{"output_type":"stream","text":["/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:4: TqdmDeprecationWarning: This function will be removed in tqdm==5.0.0\n","Please use `tqdm.notebook.tqdm` instead of `tqdm.tqdm_notebook`\n","  after removing the cwd from sys.path.\n"],"name":"stderr"},{"output_type":"display_data","data":{"application/vnd.jupyter.widget-view+json":{"model_id":"8ece86adbe9144e8a80302b081fcd68f","version_minor":0,"version_major":2},"text/plain":["HBox(children=(FloatProgress(value=0.0, max=6000.0), HTML(value='')))"]},"metadata":{"tags":[]}},{"output_type":"stream","text":["\n","Time taken in seconds = 626.8794052600861\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"FxVEAFrSXpOz","executionInfo":{"status":"ok","timestamp":1628529622045,"user_tz":-420,"elapsed":494,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["# save encoded train image\n","dump(encoding_train, open('/content/drive/MyDrive/The Anh Tran/8. RNN/Pickle/encoded_train_images.pkl', 'wb'))"],"execution_count":191,"outputs":[]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/","height":158,"referenced_widgets":["e32d3968e951410d814681f812e943ec","a9936c0d69ad4f3fa70eda4d5f1c456c","39ed082fdb6540cc98fc4cc2327bb49c","ab4d5f56634e4694acba9a1f2660f8ee","dc55e0e45c7a46588db83684e2076722","ee8a1a5ea766415c9575d07ad5ca197c","e394984ef9254c4a99491eccb4c01d40","859f4e4e870e4f40a680bbceb1f2587a"]},"id":"bo9ryCHmemSq","executionInfo":{"status":"ok","timestamp":1628529745390,"user_tz":-420,"elapsed":106856,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"9706041d-864f-48d9-88be-66051f005547"},"source":["# Encode test image\n","start = time()\n","encoding_test = {}\n","for img in tqdm_notebook(test_img):\n","    encoding_test[img[len(images):]] = encode(img)\n","print(\"Time taken in seconds =\", time()-start)"],"execution_count":193,"outputs":[{"output_type":"stream","text":["/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:4: TqdmDeprecationWarning: This function will be removed in tqdm==5.0.0\n","Please use `tqdm.notebook.tqdm` instead of `tqdm.tqdm_notebook`\n","  after removing the cwd from sys.path.\n"],"name":"stderr"},{"output_type":"display_data","data":{"application/vnd.jupyter.widget-view+json":{"model_id":"e32d3968e951410d814681f812e943ec","version_minor":0,"version_major":2},"text/plain":["HBox(children=(FloatProgress(value=0.0, max=1000.0), HTML(value='')))"]},"metadata":{"tags":[]}},{"output_type":"stream","text":["\n","Time taken in seconds = 106.49153709411621\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"2HA_n53Oew6I","executionInfo":{"status":"ok","timestamp":1628529772672,"user_tz":-420,"elapsed":482,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["# save encoded test image\n","with open('/content/drive/MyDrive/The Anh Tran/8. RNN/Pickle/encoded_test_images.pkl', 'wb') as file:\n","  dump(encoding_test, file)"],"execution_count":194,"outputs":[]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"OFrM9mdeh62k","executionInfo":{"status":"ok","timestamp":1628529774260,"user_tz":-420,"elapsed":2,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"ea45a499-6de2-4d0d-9259-6bb198eda9e9"},"source":["train_features = load(open('/content/drive/MyDrive/The Anh Tran/8. RNN/Pickle/encoded_train_images.pkl', \"rb\"))\n","print('Photos: train = ', len(train_features))"],"execution_count":195,"outputs":[{"output_type":"stream","text":["Photos: train =  6000\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"WlwgEUa5jHh8","executionInfo":{"status":"ok","timestamp":1628529775709,"user_tz":-420,"elapsed":2,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"a9c39ab1-ad7a-4d5b-f0d1-00d227558d66"},"source":["test_features = load(open('/content/drive/MyDrive/The Anh Tran/8. RNN/Pickle/encoded_test_images.pkl', 'rb'))\n","print('Photos: test = ', len(test_features))"],"execution_count":196,"outputs":[{"output_type":"stream","text":["Photos: test =  1000\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"pxvK72__jXms","executionInfo":{"status":"ok","timestamp":1628529797087,"user_tz":-420,"elapsed":481,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"8ecd68b2-3163-4f97-999d-169b077f4814"},"source":["# Tạo list các training caption\n","all_train_captions = []\n","for key, val in train_descriptions.items():\n","    for cap in val:\n","        all_train_captions.append(cap)\n","len(all_train_captions)"],"execution_count":199,"outputs":[{"output_type":"execute_result","data":{"text/plain":["30000"]},"metadata":{"tags":[]},"execution_count":199}]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"gdaJfAMkjvXC","executionInfo":{"status":"ok","timestamp":1628529799002,"user_tz":-420,"elapsed":2,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"4d2460ae-a03a-4adb-d072-bfa10ec8f089"},"source":["# Chỉ lấy các từ xuất hiện trên 10 lần\n","word_count_threshold = 10\n","word_counts = {}\n","nsents = 0\n","for sent in all_train_captions:\n","    nsents += 1\n","    for w in sent.split(' '):\n","        word_counts[w] = word_counts.get(w, 0) + 1\n","\n","vocab = [w for w in word_counts if word_counts[w] >= word_count_threshold]\n","print('preprocessed words %d -> %d' % (len(word_counts), len(vocab)))"],"execution_count":200,"outputs":[{"output_type":"stream","text":["preprocessed words 7578 -> 1651\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"KpYq9WJBkz6r","executionInfo":{"status":"ok","timestamp":1628529800549,"user_tz":-420,"elapsed":3,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["ixtoword = {}\n","wordtoix = {}\n","\n","ix = 1\n","for w in vocab:\n","    wordtoix[w] = ix\n","    ixtoword[ix] = w\n","    ix += 1"],"execution_count":201,"outputs":[]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"OsTn6zLelHJN","executionInfo":{"status":"ok","timestamp":1628529803014,"user_tz":-420,"elapsed":2,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"fd698261-08b6-41c3-e710-4ab24c6fe03a"},"source":["vocab_size = len(ixtoword) + 1 # Thêm 1 cho từ dùng để padding\n","vocab_size"],"execution_count":202,"outputs":[{"output_type":"execute_result","data":{"text/plain":["1652"]},"metadata":{"tags":[]},"execution_count":202}]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"qc4yxdUrlQjt","executionInfo":{"status":"ok","timestamp":1628529804354,"user_tz":-420,"elapsed":2,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"7c11058d-b688-484a-f088-f234c4756a6c"},"source":["# convert a dictionary of clean descriptions to a list of descriptions\n","def to_lines(descriptions):\n","\tall_desc = list()\n","\tfor key in descriptions.keys():\n","\t\t[all_desc.append(d) for d in descriptions[key]]\n","\treturn all_desc\n","\n","# calculate the length of the description with the most words\n","def max_length(descriptions):\n","\tlines = to_lines(descriptions)\n","\treturn max(len(d.split()) for d in lines)\n","\n","# determine the maximum sequence length\n","max_length = max_length(train_descriptions)\n","print('Description Length: %d' % max_length)"],"execution_count":203,"outputs":[{"output_type":"stream","text":["Description Length: 34\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"XlmG4cvrmV8f","executionInfo":{"status":"ok","timestamp":1628529806281,"user_tz":-420,"elapsed":2,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["# data generator cho việc train theo từng batch model.fit_generator()\n","def data_generator(descriptions, photos, wordtoix, max_length, num_photos_per_batch):\n","    X1, X2, y = list(), list(), list()\n","    n=0\n","    # loop for ever over images\n","    while 1:\n","        for key, desc_list in descriptions.items():\n","            n+=1\n","            # retrieve the photo feature\n","            photo = photos[key+'.jpg']\n","            for desc in desc_list:\n","                # encode the sequence\n","                seq = [wordtoix[word] for word in desc.split(' ') if word in wordtoix]\n","                # split one sequence into multiple X, y pairs\n","                for i in range(1, len(seq)):\n","                    # split into input and output pair\n","                    in_seq, out_seq = seq[:i], seq[i]\n","                    # pad input sequence\n","                    in_seq = pad_sequences([in_seq], maxlen=max_length)[0]\n","                    # encode output sequence\n","                    out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]\n","                    # store\n","                    X1.append(photo)\n","                    X2.append(in_seq)\n","                    y.append(out_seq)\n","            # yield the batch data\n","            if n==num_photos_per_batch:\n","                yield [[array(X1), array(X2)], array(y)]\n","                X1, X2, y = list(), list(), list()\n","                n=0"],"execution_count":204,"outputs":[]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"EZiJ8r28nWYx","executionInfo":{"status":"ok","timestamp":1628529832545,"user_tz":-420,"elapsed":22087,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"5fef0a92-d4b4-4741-fe80-ff8261fb3734"},"source":["embeddings_index = {} # empty dictionary\n","f = open('/content/drive/MyDrive/The Anh Tran/8. RNN/glove.6B.200d.txt', encoding=\"utf-8\")\n","\n","for line in f:\n","    values = line.split()\n","    word = values[0]\n","    coefs = np.asarray(values[1:], dtype='float32')\n","    embeddings_index[word] = coefs\n","f.close()\n","print('Found %s word vectors.' % len(embeddings_index))"],"execution_count":205,"outputs":[{"output_type":"stream","text":["Found 400001 word vectors.\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"S-_QXDvZqFp8","executionInfo":{"status":"ok","timestamp":1628529834086,"user_tz":-420,"elapsed":2,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"00f2c83a-f119-4d89-f8ba-e259ddb1fc56"},"source":["embedding_index['the']"],"execution_count":206,"outputs":[{"output_type":"execute_result","data":{"text/plain":["array([-7.1549e-02,  9.3459e-02,  2.3738e-02, -9.0339e-02,  5.6123e-02,\n","        3.2547e-01, -3.9796e-01, -9.2139e-02,  6.1181e-02, -1.8950e-01,\n","        1.3061e-01,  1.4349e-01,  1.1479e-02,  3.8158e-01,  5.4030e-01,\n","       -1.4088e-01,  2.4315e-01,  2.3036e-01, -5.5339e-01,  4.8154e-02,\n","        4.5662e-01,  3.2338e+00,  2.0199e-02,  4.9019e-02, -1.4132e-02,\n","        7.6017e-02, -1.1527e-01,  2.0060e-01, -7.7657e-02,  2.4328e-01,\n","        1.6368e-01, -3.4118e-01, -6.6070e-02,  1.0152e-01,  3.8232e-02,\n","       -1.7668e-01, -8.8153e-01, -3.3895e-01, -3.5481e-02, -5.5095e-01,\n","       -1.6899e-02, -4.3982e-01,  3.9004e-02,  4.0447e-01, -2.5880e-01,\n","        6.4594e-01,  2.6641e-01,  2.8009e-01, -2.4625e-02,  6.3302e-01,\n","       -3.1700e-01,  1.0271e-01,  3.0886e-01,  9.7792e-02, -3.8227e-01,\n","        8.6552e-02,  4.7075e-02,  2.3511e-01, -3.2127e-01, -2.8538e-01,\n","        1.6670e-01, -4.9707e-03, -6.2714e-01, -2.4904e-01,  2.9713e-01,\n","        1.4379e-01, -1.2325e-01, -5.8178e-02, -1.0290e-03, -8.2126e-02,\n","        3.6935e-01, -5.8442e-04,  3.4286e-01,  2.8426e-01, -6.8599e-02,\n","        6.5747e-01, -2.9087e-02,  1.6184e-01,  7.3672e-02, -3.0343e-01,\n","        9.5733e-02, -5.2860e-01, -2.2898e-01,  6.4079e-02,  1.5218e-02,\n","        3.4921e-01, -4.3960e-01, -4.3983e-01,  7.7515e-01, -8.7767e-01,\n","       -8.7504e-02,  3.9598e-01,  6.2362e-01, -2.6211e-01, -3.0539e-01,\n","       -2.2964e-02,  3.0567e-01,  6.7660e-02,  1.5383e-01, -1.1211e-01,\n","       -9.1540e-02,  8.2562e-02,  1.6897e-01, -3.2952e-02, -2.8775e-01,\n","       -2.2320e-01, -9.0426e-02,  1.2407e+00, -1.8244e-01, -7.5219e-03,\n","       -4.1388e-02, -1.1083e-02,  7.8186e-02,  3.8511e-01,  2.3334e-01,\n","        1.4414e-01, -9.1070e-04, -2.6388e-01, -2.0481e-01,  1.0099e-01,\n","        1.4076e-01,  2.8834e-01, -4.5429e-02,  3.7247e-01,  1.3645e-01,\n","       -6.7457e-01,  2.2786e-01,  1.2599e-01,  2.9091e-02,  3.0428e-02,\n","       -1.3028e-01,  1.9408e-01,  4.9014e-01, -3.9121e-01, -7.5952e-02,\n","        7.4731e-02,  1.8902e-01, -1.6922e-01, -2.6019e-01, -3.9771e-02,\n","       -2.4153e-01,  1.0875e-01,  3.0434e-01,  3.6009e-02,  1.4264e+00,\n","        1.2759e-01, -7.3811e-02, -2.0418e-01,  8.0016e-03,  1.5381e-01,\n","        2.0223e-01,  2.8274e-01,  9.6206e-02, -3.3634e-01,  5.0983e-01,\n","        3.2625e-01, -2.6535e-01,  3.7400e-01, -3.0388e-01, -4.0033e-01,\n","       -4.2910e-02, -6.7897e-02, -2.9332e-01,  1.0978e-01, -4.5365e-02,\n","        2.3222e-01, -3.1134e-01, -2.8983e-01, -6.6687e-01,  5.3097e-01,\n","        1.9461e-01,  3.6670e-01,  2.6185e-01, -6.5187e-01,  1.0266e-01,\n","        1.1363e-01, -1.2953e-01, -6.8246e-01, -1.8751e-01,  1.4760e-01,\n","        1.0765e+00, -2.2908e-01, -9.3435e-03, -2.0651e-01, -3.5225e-01,\n","       -2.6720e-01, -3.4307e-03,  2.5906e-01,  2.1759e-01,  6.6158e-01,\n","        1.2180e-01,  1.9957e-01, -2.0303e-01,  3.4474e-01, -2.4328e-01,\n","        1.3139e-01, -8.8767e-03,  3.3617e-01,  3.0591e-02,  2.5577e-01],\n","      dtype=float32)"]},"metadata":{"tags":[]},"execution_count":206}]},{"cell_type":"code","metadata":{"id":"QyGyyBUArNpz","executionInfo":{"status":"ok","timestamp":1628529837540,"user_tz":-420,"elapsed":468,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["embedding_dim = 200\n","\n","# Get 200-dim dense vector for each of the 10000 words in out vocabulary\n","embedding_matrix = np.zeros((vocab_size, embedding_dim))\n","\n","for word, i in wordtoix.items():\n","    #if i < max_words:\n","    embedding_vector = embeddings_index.get(word)\n","    if embedding_vector is not None:\n","        # Words not found in the embedding index will be all zeros\n","        embedding_matrix[i] = embedding_vector"],"execution_count":207,"outputs":[]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"VhbiTJiCrsIY","executionInfo":{"status":"ok","timestamp":1628529838780,"user_tz":-420,"elapsed":2,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"1c0f1856-5939-4fa3-b1fb-7542c11c2a9e"},"source":["embedding_matrix.shape"],"execution_count":208,"outputs":[{"output_type":"execute_result","data":{"text/plain":["(1652, 200)"]},"metadata":{"tags":[]},"execution_count":208}]},{"cell_type":"code","metadata":{"id":"Pt6xLMFqsM-M","executionInfo":{"status":"ok","timestamp":1628529842063,"user_tz":-420,"elapsed":1644,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["# Tạo model\n","inputs1 = Input(shape=(2048,))\n","fe1 = Dropout(0.5)(inputs1)\n","fe2 = Dense(256, activation='relu')(fe1)\n","inputs2 = Input(shape=(max_length,))\n","se1 = Embedding(vocab_size, embedding_dim, mask_zero=True)(inputs2)\n","se2 = Dropout(0.5)(se1)\n","se3 = LSTM(256)(se2)\n","decoder1 = add([fe2, se3])\n","decoder2 = Dense(256, activation='relu')(decoder1)\n","outputs = Dense(vocab_size, activation='softmax')(decoder2)\n","model = Model(inputs=[inputs1, inputs2], outputs=outputs)"],"execution_count":209,"outputs":[]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"cCpn0K5StdO_","executionInfo":{"status":"ok","timestamp":1628529844190,"user_tz":-420,"elapsed":480,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"a63673fc-2780-486d-ec59-546f1d198f6d"},"source":["model.summary()"],"execution_count":210,"outputs":[{"output_type":"stream","text":["Model: \"model_8\"\n","__________________________________________________________________________________________________\n","Layer (type)                    Output Shape         Param #     Connected to                     \n","==================================================================================================\n","input_18 (InputLayer)           [(None, 34)]         0                                            \n","__________________________________________________________________________________________________\n","input_17 (InputLayer)           [(None, 2048)]       0                                            \n","__________________________________________________________________________________________________\n","embedding_6 (Embedding)         (None, 34, 200)      330400      input_18[0][0]                   \n","__________________________________________________________________________________________________\n","dropout_12 (Dropout)            (None, 2048)         0           input_17[0][0]                   \n","__________________________________________________________________________________________________\n","dropout_13 (Dropout)            (None, 34, 200)      0           embedding_6[0][0]                \n","__________________________________________________________________________________________________\n","dense_17 (Dense)                (None, 256)          524544      dropout_12[0][0]                 \n","__________________________________________________________________________________________________\n","lstm_5 (LSTM)                   (None, 256)          467968      dropout_13[0][0]                 \n","__________________________________________________________________________________________________\n","add_5 (Add)                     (None, 256)          0           dense_17[0][0]                   \n","                                                                 lstm_5[0][0]                     \n","__________________________________________________________________________________________________\n","dense_18 (Dense)                (None, 256)          65792       add_5[0][0]                      \n","__________________________________________________________________________________________________\n","dense_19 (Dense)                (None, 1652)         424564      dense_18[0][0]                   \n","==================================================================================================\n","Total params: 1,813,268\n","Trainable params: 1,813,268\n","Non-trainable params: 0\n","__________________________________________________________________________________________________\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"uFPawgW1tpre","executionInfo":{"status":"ok","timestamp":1628529846002,"user_tz":-420,"elapsed":2,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["# Layer 2 dùng GLOVE Model nên set weight thẳng và không cần train\n","model.layers[2].set_weights([embedding_matrix])\n","model.layers[2].trainable = False"],"execution_count":211,"outputs":[]},{"cell_type":"code","metadata":{"id":"QYC2kurVuI5x","executionInfo":{"status":"ok","timestamp":1628529847456,"user_tz":-420,"elapsed":1,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["model.compile(loss='categorical_crossentropy', optimizer='adam')"],"execution_count":212,"outputs":[]},{"cell_type":"code","metadata":{"id":"YZYQiYbquRv6","executionInfo":{"status":"ok","timestamp":1628529849028,"user_tz":-420,"elapsed":1,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}}},"source":["model.optimizer.lr = 0.0001\n","epochs = 10\n","number_pics_per_bath = 6\n","steps = len(train_descriptions)//number_pics_per_bath"],"execution_count":213,"outputs":[]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/","height":746},"id":"KVDJX4G3ufP1","executionInfo":{"status":"error","timestamp":1628529849526,"user_tz":-420,"elapsed":3,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"38c090fe-b323-44cc-a74c-c882592921a9"},"source":["\n","for i in range(epochs):\n","    generator = data_generator(train_descriptions, train_features, wordtoix, max_length, number_pics_per_bath)\n","    model.fit_generator(generator, epochs=1, steps_per_epoch=steps, verbose=1)"],"execution_count":214,"outputs":[{"output_type":"stream","text":["/usr/local/lib/python3.7/dist-packages/keras/engine/training.py:1915: UserWarning: `Model.fit_generator` is deprecated and will be removed in a future version. Please use `Model.fit`, which supports generators.\n","  warnings.warn('`Model.fit_generator` is deprecated and '\n"],"name":"stderr"},{"output_type":"error","ename":"ValueError","evalue":"ignored","traceback":["\u001b[0;31m---------------------------------------------------------------------------\u001b[0m","\u001b[0;31mValueError\u001b[0m                                Traceback (most recent call last)","\u001b[0;32m<ipython-input-214-105a7f48e47e>\u001b[0m in \u001b[0;36m<module>\u001b[0;34m()\u001b[0m\n\u001b[1;32m      2\u001b[0m \u001b[0;32mfor\u001b[0m \u001b[0mi\u001b[0m \u001b[0;32min\u001b[0m \u001b[0mrange\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mepochs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m      3\u001b[0m     \u001b[0mgenerator\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mdata_generator\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mtrain_descriptions\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mtrain_features\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mwordtoix\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mmax_length\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mnumber_pics_per_bath\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m----> 4\u001b[0;31m     \u001b[0mmodel\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mfit_generator\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mgenerator\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mepochs\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;36m1\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0msteps_per_epoch\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0msteps\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mverbose\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;36m1\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m","\u001b[0;32m/usr/local/lib/python3.7/dist-packages/keras/engine/training.py\u001b[0m in \u001b[0;36mfit_generator\u001b[0;34m(self, generator, steps_per_epoch, epochs, verbose, callbacks, validation_data, validation_steps, validation_freq, class_weight, max_queue_size, workers, use_multiprocessing, shuffle, initial_epoch)\u001b[0m\n\u001b[1;32m   1930\u001b[0m         \u001b[0muse_multiprocessing\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0muse_multiprocessing\u001b[0m\u001b[0;34m,\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m   1931\u001b[0m         \u001b[0mshuffle\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0mshuffle\u001b[0m\u001b[0;34m,\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m-> 1932\u001b[0;31m         initial_epoch=initial_epoch)\n\u001b[0m\u001b[1;32m   1933\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m   1934\u001b[0m   def evaluate_generator(self,\n","\u001b[0;32m/usr/local/lib/python3.7/dist-packages/keras/engine/training.py\u001b[0m in \u001b[0;36mfit\u001b[0;34m(self, x, y, batch_size, epochs, verbose, callbacks, validation_split, validation_data, shuffle, class_weight, sample_weight, initial_epoch, steps_per_epoch, validation_steps, validation_batch_size, validation_freq, max_queue_size, workers, use_multiprocessing)\u001b[0m\n\u001b[1;32m   1156\u001b[0m                 _r=1):\n\u001b[1;32m   1157\u001b[0m               \u001b[0mcallbacks\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mon_train_batch_begin\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mstep\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m-> 1158\u001b[0;31m               \u001b[0mtmp_logs\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mtrain_function\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0miterator\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m   1159\u001b[0m               \u001b[0;32mif\u001b[0m \u001b[0mdata_handler\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mshould_sync\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m   1160\u001b[0m                 \u001b[0mcontext\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0masync_wait\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;32m/usr/local/lib/python3.7/dist-packages/tensorflow/python/eager/def_function.py\u001b[0m in \u001b[0;36m__call__\u001b[0;34m(self, *args, **kwds)\u001b[0m\n\u001b[1;32m    887\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    888\u001b[0m       \u001b[0;32mwith\u001b[0m \u001b[0mOptionalXlaContext\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_jit_compile\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 889\u001b[0;31m         \u001b[0mresult\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_call\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m*\u001b[0m\u001b[0margs\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m**\u001b[0m\u001b[0mkwds\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    890\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    891\u001b[0m       \u001b[0mnew_tracing_count\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mexperimental_get_tracing_count\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;32m/usr/local/lib/python3.7/dist-packages/tensorflow/python/eager/def_function.py\u001b[0m in \u001b[0;36m_call\u001b[0;34m(self, *args, **kwds)\u001b[0m\n\u001b[1;32m    931\u001b[0m       \u001b[0;31m# This is the first call of __call__, so we have to initialize.\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    932\u001b[0m       \u001b[0minitializers\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0;34m[\u001b[0m\u001b[0;34m]\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 933\u001b[0;31m       \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_initialize\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0margs\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mkwds\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0madd_initializers_to\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0minitializers\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    934\u001b[0m     \u001b[0;32mfinally\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    935\u001b[0m       \u001b[0;31m# At this point we know that the initialization is complete (or less\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;32m/usr/local/lib/python3.7/dist-packages/tensorflow/python/eager/def_function.py\u001b[0m in \u001b[0;36m_initialize\u001b[0;34m(self, args, kwds, add_initializers_to)\u001b[0m\n\u001b[1;32m    762\u001b[0m     self._concrete_stateful_fn = (\n\u001b[1;32m    763\u001b[0m         self._stateful_fn._get_concrete_function_internal_garbage_collected(  # pylint: disable=protected-access\n\u001b[0;32m--> 764\u001b[0;31m             *args, **kwds))\n\u001b[0m\u001b[1;32m    765\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    766\u001b[0m     \u001b[0;32mdef\u001b[0m \u001b[0minvalid_creator_scope\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m*\u001b[0m\u001b[0munused_args\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m**\u001b[0m\u001b[0munused_kwds\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;32m/usr/local/lib/python3.7/dist-packages/tensorflow/python/eager/function.py\u001b[0m in \u001b[0;36m_get_concrete_function_internal_garbage_collected\u001b[0;34m(self, *args, **kwargs)\u001b[0m\n\u001b[1;32m   3048\u001b[0m       \u001b[0margs\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mkwargs\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0;32mNone\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;32mNone\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m   3049\u001b[0m     \u001b[0;32mwith\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_lock\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m-> 3050\u001b[0;31m       \u001b[0mgraph_function\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0m_\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_maybe_define_function\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0margs\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mkwargs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m   3051\u001b[0m     \u001b[0;32mreturn\u001b[0m \u001b[0mgraph_function\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m   3052\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;32m/usr/local/lib/python3.7/dist-packages/tensorflow/python/eager/function.py\u001b[0m in \u001b[0;36m_maybe_define_function\u001b[0;34m(self, args, kwargs)\u001b[0m\n\u001b[1;32m   3442\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m   3443\u001b[0m           \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_function_cache\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mmissed\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0madd\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mcall_context_key\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m-> 3444\u001b[0;31m           \u001b[0mgraph_function\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_create_graph_function\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0margs\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mkwargs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m   3445\u001b[0m           \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_function_cache\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mprimary\u001b[0m\u001b[0;34m[\u001b[0m\u001b[0mcache_key\u001b[0m\u001b[0;34m]\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mgraph_function\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m   3446\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;32m/usr/local/lib/python3.7/dist-packages/tensorflow/python/eager/function.py\u001b[0m in \u001b[0;36m_create_graph_function\u001b[0;34m(self, args, kwargs, override_flat_arg_shapes)\u001b[0m\n\u001b[1;32m   3287\u001b[0m             \u001b[0marg_names\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0marg_names\u001b[0m\u001b[0;34m,\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m   3288\u001b[0m             \u001b[0moverride_flat_arg_shapes\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0moverride_flat_arg_shapes\u001b[0m\u001b[0;34m,\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m-> 3289\u001b[0;31m             capture_by_value=self._capture_by_value),\n\u001b[0m\u001b[1;32m   3290\u001b[0m         \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_function_attributes\u001b[0m\u001b[0;34m,\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m   3291\u001b[0m         \u001b[0mfunction_spec\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mfunction_spec\u001b[0m\u001b[0;34m,\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;32m/usr/local/lib/python3.7/dist-packages/tensorflow/python/framework/func_graph.py\u001b[0m in \u001b[0;36mfunc_graph_from_py_func\u001b[0;34m(name, python_func, args, kwargs, signature, func_graph, autograph, autograph_options, add_control_dependencies, arg_names, op_return_value, collections, capture_by_value, override_flat_arg_shapes)\u001b[0m\n\u001b[1;32m    997\u001b[0m         \u001b[0m_\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0moriginal_func\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mtf_decorator\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0munwrap\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mpython_func\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    998\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 999\u001b[0;31m       \u001b[0mfunc_outputs\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mpython_func\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m*\u001b[0m\u001b[0mfunc_args\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m**\u001b[0m\u001b[0mfunc_kwargs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m   1000\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m   1001\u001b[0m       \u001b[0;31m# invariant: `func_outputs` contains only Tensors, CompositeTensors,\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;32m/usr/local/lib/python3.7/dist-packages/tensorflow/python/eager/def_function.py\u001b[0m in \u001b[0;36mwrapped_fn\u001b[0;34m(*args, **kwds)\u001b[0m\n\u001b[1;32m    670\u001b[0m         \u001b[0;31m# the function a weak reference to itself to avoid a reference cycle.\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    671\u001b[0m         \u001b[0;32mwith\u001b[0m \u001b[0mOptionalXlaContext\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mcompile_with_xla\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 672\u001b[0;31m           \u001b[0mout\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mweak_wrapped_fn\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m__wrapped__\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m*\u001b[0m\u001b[0margs\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m**\u001b[0m\u001b[0mkwds\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    673\u001b[0m         \u001b[0;32mreturn\u001b[0m \u001b[0mout\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    674\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;32m/usr/local/lib/python3.7/dist-packages/tensorflow/python/framework/func_graph.py\u001b[0m in \u001b[0;36mwrapper\u001b[0;34m(*args, **kwargs)\u001b[0m\n\u001b[1;32m    984\u001b[0m           \u001b[0;32mexcept\u001b[0m \u001b[0mException\u001b[0m \u001b[0;32mas\u001b[0m \u001b[0me\u001b[0m\u001b[0;34m:\u001b[0m  \u001b[0;31m# pylint:disable=broad-except\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    985\u001b[0m             \u001b[0;32mif\u001b[0m \u001b[0mhasattr\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0me\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m\"ag_error_metadata\"\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 986\u001b[0;31m               \u001b[0;32mraise\u001b[0m \u001b[0me\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mag_error_metadata\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mto_exception\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0me\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    987\u001b[0m             \u001b[0;32melse\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    988\u001b[0m               \u001b[0;32mraise\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;31mValueError\u001b[0m: in user code:\n\n    /usr/local/lib/python3.7/dist-packages/keras/engine/training.py:830 train_function  *\n        return step_function(self, iterator)\n    /usr/local/lib/python3.7/dist-packages/keras/engine/training.py:813 run_step  *\n        outputs = model.train_step(data)\n    /usr/local/lib/python3.7/dist-packages/keras/engine/training.py:770 train_step  *\n        y_pred = self(x, training=True)\n    /usr/local/lib/python3.7/dist-packages/keras/engine/base_layer.py:989 __call__  *\n        input_spec.assert_input_compatibility(self.input_spec, inputs, self.name)\n    /usr/local/lib/python3.7/dist-packages/keras/engine/input_spec.py:197 assert_input_compatibility  *\n        raise ValueError('Layer ' + layer_name + ' expects ' +\n\n    ValueError: Layer model_8 expects 2 input(s), but it received 3 input tensors. Inputs received: [<tf.Tensor 'IteratorGetNext:0' shape=(None, None) dtype=float32>, <tf.Tensor 'IteratorGetNext:1' shape=(None, None) dtype=int32>, <tf.Tensor 'IteratorGetNext:2' shape=(None, None) dtype=float32>]\n"]}]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"V9X6lXxN3WsA","executionInfo":{"status":"ok","timestamp":1628529783511,"user_tz":-420,"elapsed":470,"user":{"displayName":"Anh Trần Thế","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GhwRUXV5nDKyl90kqIuGsQNEGAgqKDiPpv7cMGB=s64","userId":"03576004377265534724"}},"outputId":"bd8aceba-34ec-4cd2-bf0f-87415582830c"},"source":["len(encoding_train)"],"execution_count":197,"outputs":[{"output_type":"execute_result","data":{"text/plain":["6000"]},"metadata":{"tags":[]},"execution_count":197}]},{"cell_type":"code","metadata":{"id":"pC1Bz8K52a4c"},"source":["model.save_weights('./model_weights/model_30.h5')"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"MrVDPQjy2h_k"},"source":["# Với môi ảnh mới khi test, ta sẽ bắt đầu chuỗi với 'startseq' rồi sau đó cho vào model để dự đoán từ tiếp theo. Ta thêm từ\n","# vừa được dự đoán vào chuỗi và tiếp tục cho đến khi gặp 'endseq' là kết thúc hoặc cho đến khi chuỗi dài 34 từ.\n","def greedySearch(photo):\n","    in_text = 'startseq'\n","    for i in range(max_length):\n","        sequence = [wordtoix[w] for w in in_text.split() if w in wordtoix]\n","        sequence = pad_sequences([sequence], maxlen=max_length)\n","        yhat = model.predict([photo,sequence], verbose=0)\n","        yhat = np.argmax(yhat)\n","        word = ixtoword[yhat]\n","        in_text += ' ' + word\n","        if word == 'endseq':\n","            break\n","    final = in_text.split()\n","    final = final[1:-1]\n","    final = ' '.join(final)\n","    return final"],"execution_count":null,"outputs":[]},{"cell_type":"code","metadata":{"id":"jQd0lC7Q2kTd"},"source":["z=5\n","pic = list(encoding_test.keys())[z]\n","image = encoding_test[pic].reshape((1,2048))\n","x=plt.imread(images+pic)\n","plt.imshow(x)\n","plt.show()\n","print(greedySearch(image))"],"execution_count":null,"outputs":[]}]}